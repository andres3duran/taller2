name: Export NASA Images

on:
  push:
    branches:
      - main

jobs:
  export_images:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Load dates from JSON
        id: load_dates
        run: |
          dates=$(jq -r '.dates[]' dates.json | tr '\n' ' ')
          echo "dates=${dates}" >> $GITHUB_ENV

      - name: Create cache directory
        run: mkdir -p cache  # Crear el directorio cache

      - name: Validate and Download images
        run: |
          mkdir -p images
          for date in $dates; do
            # Check if the date format is valid (YYYY-MM-DD)
            if ! [[ $date =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              echo "Invalid date format: $date"
              continue
            fi
            
            echo "Processing date: $date"
            if [ -f "cache/$date.json" ]; then
              echo "Using cached data for date: $date"
              url=$(jq -r '.url' cache/$date.json)
            else
              response=$(curl -s "https://api.nasa.gov/planetary/apod?api_key=${{ secrets.NASA_API_KEY }}&date=$date")
              echo "$response" > "cache/$date.json"
              url=$(echo "$response" | jq -r '.url')
            fi
            
            if [ "$url" != "null" ]; then
              echo "Downloading image from $url"
              curl -s -o "images/img-$date.jpg" "$url"
            else
              echo "No image found for date: $date"
            fi
          done

      - name: Upload images as artifacts
        uses: actions/upload-artifact@v3
        with:
          name: "NASA Images"
          path: images/*
          retention-days: 1
